import io from"https://cdn.socket.io/4.7.5/socket.io.esm.min.js";let TETROMINO=[{},{x:1,y:0,width:1,height:4,color:"#5050D0",posData:[1,0,1,1,1,2,1,3]},{x:1,y:0,width:2,height:3,color:"#2121C0",posData:[2,0,2,1,2,2,1,2]},{x:1,y:0,width:2,height:3,color:"#A96642",posData:[1,0,1,1,1,2,2,2]},{x:1,y:1,width:2,height:2,color:"#D4D80F",posData:[1,1,1,2,2,1,2,2]},{x:1,y:1,width:3,height:2,color:"#0FDC0F",posData:[2,1,3,1,1,2,2,2]},{x:1,y:1,width:3,height:2,color:"#D066D0",posData:[1,1,2,1,3,1,2,2]},{x:1,y:1,width:3,height:2,color:"#C03030",posData:[1,1,2,1,2,2,3,2]}],randInt=(t,e)=>Math.floor(Math.random()*(e-t))+t,posRotate=(t,e,i)=>{var s=[0,1,0,-1][i],i=[1,0,-1,0][i],t=t-1.5,e=e-1.5;return[t*i-e*s+1.5,t*s+e*i+1.5]};class EventEmitter extends EventTarget{constructor(){super()}emit(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))}}class Input extends EventEmitter{static INPUT={blockLeft:"blockLeft",blockRight:"blockRight",blockDown:"blockDown",blockHardDrop:"blockHardDrop",blockSpinClockwise:"blockSpinClockwise",blockSwap:"blockSwap"};#data={down:{}};#keyMapping={blockLeft:"ArrowLeft",blockRight:"ArrowRight",blockDown:"ArrowDown",blockHardDrop:" ",blockSpinClockwise:"ArrowUp",blockSwap:"Shift"};#keyMappingRev={};#isListening=!1;get isListening(){return this.#isListening}onKeyDownBind;onKeyUpBind;constructor(){super(),this.onKeyDownBind=this.#onKeyDown.bind(this),this.onKeyUpBind=this.#onKeyUp.bind(this),this.init()}init(){this.removeListen(),this.#keyMappingRev={},this.#data.down={},Object.entries(this.#keyMapping).forEach(([t,e])=>{this.#keyMappingRev[e]=t,this.#data.down[t]=!1})}addListen(){!0!==this.#isListening&&(this.#isListening=!0,window.addEventListener("keydown",this.onKeyDownBind),window.addEventListener("keyup",this.onKeyUpBind))}removeListen(){!1!==this.#isListening&&(this.#isListening=!1,window.removeEventListener("keydown",this.onKeyDownBind),window.removeEventListener("keyup",this.onKeyUpBind))}isDown(t){return void 0!==this.#data.down[t]&&this.#data.down[t]}#onKeyDown(t){t=this.#keyMappingRev[t.key];void 0!==t&&(this.emit(t),this.#data.down[t]=!0)}#onKeyUp(t){t=this.#keyMappingRev[t.key];void 0!==t&&(this.#data.down[t]=!1)}}class TileMap{static LEN_X=10;static LEN_Y=20;data=new Int8Array(TileMap.LEN_X*TileMap.LEN_Y);init(){this.data=new Int8Array(TileMap.LEN_X*TileMap.LEN_Y)}#removeLine(e){for(;1<=e;e--)for(let t=0;t<TileMap.LEN_X;t++)this.setBlock(t,e,this.getBlock(t,e-1))}checkFullLine(){let t=0;t:for(let e=TileMap.LEN_Y-1;1<=e;e--){for(let t=0;t<TileMap.LEN_X;t++)if(0===this.getBlock(t,e))continue t;t++,this.#removeLine(e),e++}return t}getBlock(t,e){return this.data[t+e*TileMap.LEN_X]}setBlock(t,e,i){this.data[t+e*TileMap.LEN_X]=i}}class CurrBlock extends EventEmitter{static COLID_WALL_LEFT=0;static COLID_WALL_RIGHT=1;static COLID_FLOOR=2;static COLID_MAP_BLOCK=3;static ON_PLACED="ON_PLACED";#isSwaped=!1;x=0;y=0;spinType=0;type=randInt(1,7);nextType=randInt(1,7);holdType=0;gameSystem;constructor(t){super(),this.gameSystem=t,this.gameSystem.input.addEventListener(Input.INPUT.blockHardDrop,()=>this.hardDrop()),this.gameSystem.input.addEventListener(Input.INPUT.blockDown,()=>this.moveDown()),this.gameSystem.input.addEventListener(Input.INPUT.blockLeft,()=>this.moveLeft()),this.gameSystem.input.addEventListener(Input.INPUT.blockRight,()=>this.moveRight()),this.gameSystem.input.addEventListener(Input.INPUT.blockSpinClockwise,()=>this.spin()),this.gameSystem.input.addEventListener(Input.INPUT.blockSwap,()=>this.swap())}init(){this.x=0,this.y=0,this.spinType=0,this.#isSwaped=!1,this.type=randInt(1,7),this.nextType=randInt(1,7),this.holdType=0}#initPos(){this.x=0,this.y=0,this.spinType=0}#changeToNext(){this.type=this.nextType,this.nextType=randInt(1,7)}#place(){var e=TETROMINO[this.type].posData;for(let t=0;t<8;t+=2){var[i,s]=posRotate(e[t],e[t+1],this.spinType);this.gameSystem.tileMap.setBlock(i+this.x,s+this.y,this.type)}this.#isSwaped=!1,this.#changeToNext(),this.#initPos(),this.emit(CurrBlock.ON_PLACED)}#isColid(...t){var e=TETROMINO[this.type].posData;let i=[!1,!1,!1,!1];for(let t=0;t<8;t+=2){var[s,n]=posRotate(e[t],e[t+1],this.spinType),s=s+this.x,n=n+this.y;s<0&&(i[CurrBlock.COLID_WALL_LEFT]=!0),s>=TileMap.LEN_X&&(i[CurrBlock.COLID_WALL_RIGHT]=!0),n>=TileMap.LEN_Y&&(i[CurrBlock.COLID_FLOOR]=!0),0!=this.gameSystem.tileMap.getBlock(s,n)&&(i[CurrBlock.COLID_MAP_BLOCK]=!0)}let r=!1;return t.forEach(t=>{!0===i[t]&&(r=!0)}),r}moveLeft(){this.x--,!0===this.#isColid(CurrBlock.COLID_WALL_LEFT,CurrBlock.COLID_MAP_BLOCK)&&this.x++}moveRight(){this.x++,!0===this.#isColid(CurrBlock.COLID_WALL_RIGHT,CurrBlock.COLID_MAP_BLOCK)&&this.x--}spin(){if(3<++this.spinType&&(this.spinType=0),!0===this.#isColid(CurrBlock.COLID_FLOOR,CurrBlock.COLID_MAP_BLOCK))--this.spinType<0&&(this.spinType=3);else{for(;!0===this.#isColid(CurrBlock.COLID_WALL_LEFT);)this.x++;for(;!0===this.#isColid(CurrBlock.COLID_WALL_RIGHT);)this.x--}}moveDown(){this.y++,!0===this.#isColid(CurrBlock.COLID_FLOOR,CurrBlock.COLID_MAP_BLOCK)&&(this.y--,this.#place())}hardDrop(){this.y=this.getHardDropY(),this.#place()}swap(){var t;!0!==this.#isSwaped&&(this.#isSwaped=!0,0===this.holdType?(this.holdType=this.type,this.#changeToNext()):(t=this.holdType,this.holdType=this.type,this.type=t),this.#initPos())}getHardDropY(){for(var t=this.y;!1===this.#isColid(CurrBlock.COLID_FLOOR,CurrBlock.COLID_MAP_BLOCK);)this.y++;this.y--;var e=this.y;return this.y=t,e}}class Render{static BLOCK_SIZE=28;static GRID_W=TileMap.LEN_X*Render.BLOCK_SIZE;static GRID_H=TileMap.LEN_Y*Render.BLOCK_SIZE;gameSystem;#canvas;#ctx;#isGrayscale=!1;get isGrayscale(){return this.#isGrayscale}set isGrayscale(t){this.#isGrayscale=t,this.#canvas.style.filter=!0===t?"grayscale(1)":"none"}get width(){return this.#canvas.width}set width(t){this.#canvas.width=t}get height(){return this.#canvas.height}set height(t){this.#canvas.height=t}constructor(t,e,i){this.#canvas=e,this.#ctx=i,this.gameSystem=t,this.resize(),window.addEventListener("resize",()=>this.resize())}init(){this.isGrayscale=!1,this.resize()}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.render()}#centerPos(t,e){return[this.width/2+t,this.height/2-e]}#gridPos(t,e){return this.#centerPos((t-TileMap.LEN_X/2)*Render.BLOCK_SIZE,(-e+TileMap.LEN_Y/2)*Render.BLOCK_SIZE)}render(){this.#ctx.clearRect(0,0,this.#canvas.width,this.#canvas.height),this.#renderGrid(),this.#renderScore(),this.#renderRank(),this.#renderNextBlock(),this.#renderHoldedBlock(),this.#renderMapBlock(),this.#renderCurrBlockShadow(),this.#renderCurrBlock(),this.#renderComboEffect(),!0===this.gameSystem.isEnd&&this.#renderGameEnd()}#renderGameEnd(){var t=this.#ctx;t.font="700 24px Arial",t.fillStyle="#000000",t.fillText("Game End",...this.#centerPos(-60,-300))}#renderGrid(){var e=this.#ctx;e.strokeStyle="#DDDDDD",e.fillStyle="#EFEFEF",e.lineWidth=.5,e.beginPath(),e.rect(...this.#centerPos(-Render.GRID_W/2,Render.GRID_H/2),Render.GRID_W,Render.GRID_H),e.fill(),e.stroke(),e.beginPath();for(let t=0;t<TileMap.LEN_X;t++){var i=(t/TileMap.LEN_X-.5)*Render.GRID_W;e.moveTo(...this.#centerPos(i,Render.GRID_H/2)),e.lineTo(...this.#centerPos(i,-Render.GRID_H/2))}for(let t=0;t<TileMap.LEN_Y;t++){var s=(t/TileMap.LEN_Y-.5)*Render.GRID_H;e.moveTo(...this.#centerPos(-Render.GRID_W/2,s)),e.lineTo(...this.#centerPos(Render.GRID_W/2,s))}e.stroke()}#renderScore(){var t=this.#ctx;t.font="600 22px Arial",t.fillStyle="#222222",t.fillText(this.gameSystem.score,...this.#centerPos(Render.GRID_W/2+20,Render.GRID_H/2-25)),t.font="16px Arial",t.fillStyle="#222222",t.fillText("Level "+this.gameSystem.level,...this.#centerPos(Render.GRID_W/2+20,60))}#renderRank(){var t=this.#ctx;t.font="600 22px Arial",t.fillStyle="#222222",t.fillText(this.gameSystem.rank+"위",...this.#centerPos(Render.GRID_W/2+20,0))}#renderMapBlock(){var i=this.#ctx;i.beginPath();let s=0;for(let e=0;e<TileMap.LEN_Y;e++)for(let t=0;t<TileMap.LEN_X;t++){var n=this.gameSystem.tileMap.data[s++];0!==n&&(i.fillStyle=TETROMINO[n].color,i.fillRect(...this.#gridPos(t,e),Render.BLOCK_SIZE,Render.BLOCK_SIZE))}}#renderCurrBlock(){var e=this.#ctx,i=TETROMINO[this.gameSystem.currBlock.type].posData;e.fillStyle=TETROMINO[this.gameSystem.currBlock.type].color,e.beginPath();for(let t=0;t<8;t+=2){var[s,n]=posRotate(i[t],i[t+1],this.gameSystem.currBlock.spinType);e.rect(...this.#gridPos(s+this.gameSystem.currBlock.x,n+this.gameSystem.currBlock.y),Render.BLOCK_SIZE,Render.BLOCK_SIZE)}e.fill()}#renderCurrBlockShadow(){var e=this.#ctx,i=TETROMINO[this.gameSystem.currBlock.type].posData,s=this.gameSystem.currBlock.getHardDropY();e.fillStyle="#cccccc",e.beginPath();for(let t=0;t<8;t+=2){var[n,r]=posRotate(i[t],i[t+1],this.gameSystem.currBlock.spinType);e.rect(...this.#gridPos(n+this.gameSystem.currBlock.x,r+s),Render.BLOCK_SIZE,Render.BLOCK_SIZE)}e.fill()}#renderNextBlock(){var e=this.#ctx,i=TETROMINO[this.gameSystem.currBlock.nextType],s=i.posData;e.strokeStyle="#DDDDDD",e.fillStyle="#EFEFEF",e.beginPath(),e.rect(...this.#centerPos(Render.GRID_W/2+20,Render.GRID_H/2-60),130,130),e.fill(),e.stroke(),e.font="14px Arial",e.fillStyle="#555555",e.fillText("Next",...this.#centerPos(Render.GRID_W/2+20,Render.GRID_H/2-55)),e.fillStyle=TETROMINO[this.gameSystem.currBlock.nextType].color,e.beginPath();for(let t=0;t<8;t+=2){var n=s[t]-i.x,r=s[t+1]-i.y;e.rect(...this.#centerPos((n-i.width/2)*Render.BLOCK_SIZE+225,(-r+i.height/2)*Render.BLOCK_SIZE+155),Render.BLOCK_SIZE,Render.BLOCK_SIZE)}e.fill()}#renderHoldedBlock(){var e=this.#ctx,i=TETROMINO[this.gameSystem.currBlock.holdType],s=i.posData;if(e.strokeStyle="#DDDDDD",e.fillStyle="#EFEFEF",e.beginPath(),e.rect(...this.#centerPos(-Render.GRID_W/2-150,Render.GRID_H/2-60),130,130),e.fill(),e.stroke(),e.font="14px Arial",e.fillStyle="#555555",e.fillText("Hold",...this.#centerPos(-Render.GRID_W/2-150,Render.GRID_H/2-55)),0!==this.gameSystem.currBlock.holdType){e.fillStyle=i.color,e.beginPath();for(let t=0;t<8;t+=2){var n=s[t]-i.x,r=s[t+1]-i.y;e.rect(...this.#centerPos((n-i.width/2)*Render.BLOCK_SIZE-225,(-r+i.height/2)*Render.BLOCK_SIZE+155),Render.BLOCK_SIZE,Render.BLOCK_SIZE)}e.fill()}}#renderComboEffect(){var t;0!==this.gameSystem.combo&&((t=this.#ctx).font="700 24px Arial",t.fillStyle="#f55211",t.fillText(this.gameSystem.combo+"콤보 (놀랍다!)",...this.#centerPos(Render.GRID_W/2+20,30)))}}class GameSystem extends EventEmitter{static ON_AFTER_PLACED="ON_AFTER_PLACED";static ON_END="ON_END";#isRunning=!1;#isEnd=!1;#tickLoopId=null;#blockDownLoopId=null;score=0;combo=0;level=1;rank=0;#cntToLevelUp=5;tileMap;currBlock;render;input;get isRunning(){return this.#isRunning}get isEnd(){return this.#isEnd}onCurrBlockPlacedBind;constructor(t){if(null===t)throw new Error("캔버스 없음.");var e=t.getContext("2d");if(null===e)throw new Error("Context 생성 오류.");super(),this.onCurrBlockPlacedBind=this.#onCurrBlockPlaced.bind(this),this.tileMap=new TileMap,this.input=new Input,this.currBlock=new CurrBlock(this),this.render=new Render(this,t,e),this.render.render()}init(){null!==this.#tickLoopId&&cancelAnimationFrame(this.#tickLoopId),null!==this.#blockDownLoopId&&clearInterval(this.#blockDownLoopId),!0===this.input.isListening&&this.input.removeListen(),this.currBlock.removeEventListener(CurrBlock.ON_PLACED,this.onCurrBlockPlacedBind),this.#isRunning=!1,this.#isEnd=!1,this.#tickLoopId=null,this.#blockDownLoopId=null,this.score=0,this.combo=0,this.level=1,this.rank=0,this.#cntToLevelUp=5,this.tileMap.init(),this.currBlock.init(),this.input.init(),this.render.init()}#isEndCondition(){for(let t=0;t<2*TileMap.LEN_X;t++)if(0!==this.tileMap.data[t])return!0;return!1}#onCurrBlockPlaced(){var t=this.tileMap.checkFullLine();this.#cntToLevelUp-=t,this.#cntToLevelUp<0&&(this.level++,this.#cntToLevelUp=5,clearInterval(this.#blockDownLoopId),this.#blockDownLoopId=setInterval(()=>this.#moveBlockDown(),700/this.level)),0===t?this.combo=0:(this.combo+=1,this.score+=100*(this.combo+t)),this.emit(GameSystem.ON_AFTER_PLACED),!0===this.#isEndCondition()&&this.end()}start(){!0!==this.#isRunning&&(this.#isRunning=!0,this.render.isGrayscale=!1,this.#tickLoopId=requestAnimationFrame(()=>this.#tickLoop()),this.#blockDownLoopId=setInterval(()=>this.#moveBlockDown(),700),this.input.addListen(),this.currBlock.addEventListener(CurrBlock.ON_PLACED,this.onCurrBlockPlacedBind))}end(){!1!==this.#isRunning&&(this.#isRunning=!1,this.#isEnd=!0,clearInterval(this.#blockDownLoopId),this.input.removeListen(),this.currBlock.removeEventListener(CurrBlock.ON_PLACED,this.onCurrBlockPlacedBind),this.#tickLoopId=null,this.#blockDownLoopId=null,this.render.isGrayscale=!0,this.emit(GameSystem.ON_END),setTimeout(()=>{cancelAnimationFrame(this.#tickLoopId)},100))}#tick(){this.render.render()}#tickLoop(){this.#tick(),requestAnimationFrame(()=>this.#tickLoop())}#moveBlockDown(){!1===this.input.isDown(Input.INPUT.blockDown)&&this.currBlock.moveDown()}}class GameSocket{static SERVER_URL="localhost:3000";userNo=null;socket;gameSystem;constructor(t){this.socket=io.connect(GameSocket.SERVER_URL),this.gameSystem=t;let e=this.socket;e.on("updateRank",t=>{t.forEach((t,e)=>{t.sessionId===this.socket.id&&(this.gameSystem.rank=e+1)})}),e.on("roomGameDone",()=>this.gameSystem.init()),e.on("gameReady",()=>this.gameSystem.start()),this.gameSystem.addEventListener(GameSystem.ON_AFTER_PLACED,()=>{this.#sendData()}),this.gameSystem.addEventListener(GameSystem.ON_END,()=>{e.emit("gameEnd")}),e.on("joinGameRoom_success",({userNo:t})=>{this.userNo=t}),e.on("joinGameRoom_failed",()=>{throw new Error("Socket 참여 오류.")}),e.emit("joinGameRoom")}#sendData(){this.socket.emit("updateGameData",{map:this.gameSystem.tileMap.data.buffer,score:this.gameSystem.score,level:this.gameSystem.level})}}window.onload=()=>{var t=document.getElementById("canvas");window.gameSystem=new GameSystem(t),window.gameSocket=new GameSocket(window.gameSystem)};